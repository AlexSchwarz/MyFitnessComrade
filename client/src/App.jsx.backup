import { useState, useEffect } from 'react'
import './App.css'
import { signIn, logout, subscribeToAuthChanges } from './services/firebase'
import { getUserGoal, setUserGoal, addMeal, getTodaysMeals, deleteMeal } from './services/calories'
import { getUserProducts, addProduct, updateProduct, deleteProduct, calculateCalories } from './services/products'

function App() {
  const [user, setUser] = useState(null)
  const [authLoading, setAuthLoading] = useState(true)

  // Login state
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loginError, setLoginError] = useState(null)
  const [loginLoading, setLoginLoading] = useState(false)

  // Calorie tracking state
  const [dailyGoal, setDailyGoal] = useState(2000)
  const [meals, setMeals] = useState([])
  const [totalCalories, setTotalCalories] = useState(0)
  const [isEditingGoal, setIsEditingGoal] = useState(false)
  const [goalInput, setGoalInput] = useState('')

  // Products state
  const [products, setProducts] = useState([])
  const [showProductForm, setShowProductForm] = useState(false)
  const [productFormName, setProductFormName] = useState('')
  const [productFormCalories, setProductFormCalories] = useState('')
  const [productError, setProductError] = useState(null)
  const [productLoading, setProductLoading] = useState(false)
  const [editingProductId, setEditingProductId] = useState(null)

  // Meal form state
  const [selectedProductId, setSelectedProductId] = useState('')
  const [grams, setGrams] = useState('')
  const [calculatedCalories, setCalculatedCalories] = useState(0)
  const [mealError, setMealError] = useState(null)
  const [mealLoading, setMealLoading] = useState(false)

  // Subscribe to auth state changes
  useEffect(() => {
    const unsubscribe = subscribeToAuthChanges((user) => {
      setUser(user)
      setAuthLoading(false)
    })
    return () => unsubscribe()
  }, [])

  // Load user data when logged in
  useEffect(() => {
    if (user) {
      loadUserData()
    }
  }, [user])

  // Calculate total calories whenever meals change
  useEffect(() => {
    const total = meals.reduce((sum, meal) => sum + meal.calories, 0)
    setTotalCalories(total)
  }, [meals])

  // Calculate calories when product or grams change
  useEffect(() => {
    if (selectedProductId && grams) {
      const product = products.find(p => p.id === selectedProductId)
      if (product) {
        const calories = calculateCalories(product.caloriesPer100g, parseFloat(grams))
        setCalculatedCalories(calories)
      }
    } else {
      setCalculatedCalories(0)
    }
  }, [selectedProductId, grams, products])

  const loadUserData = async () => {
    try {
      const [goal, todaysMeals, userProducts] = await Promise.all([
        getUserGoal(user.uid),
        getTodaysMeals(user.uid),
        getUserProducts(user.uid)
      ])

      setDailyGoal(goal)
      setMeals(todaysMeals)
      setProducts(userProducts)
    } catch (err) {
      console.error('Error loading user data:', err)
    }
  }

  const handleLogin = async (e) => {
    e.preventDefault()

    if (!email.trim() || !password.trim()) {
      setLoginError('Please enter email and password')
      return
    }

    try {
      setLoginLoading(true)
      setLoginError(null)
      await signIn(email, password)
      setEmail('')
      setPassword('')
    } catch (err) {
      setLoginError(err.message)
    } finally {
      setLoginLoading(false)
    }
  }

  const handleLogout = async () => {
    try {
      await logout()
      setMeals([])
      setProducts([])
      setDailyGoal(2000)
    } catch (err) {
      console.error('Logout error:', err)
    }
  }

  const handleEditGoal = () => {
    setGoalInput(dailyGoal.toString())
    setIsEditingGoal(true)
  }

  const handleSaveGoal = async () => {
    const newGoal = parseInt(goalInput)
    if (isNaN(newGoal) || newGoal <= 0) {
      return
    }

    try {
      await setUserGoal(user.uid, newGoal)
      setDailyGoal(newGoal)
      setIsEditingGoal(false)
    } catch (err) {
      console.error('Error updating goal:', err)
    }
  }

  // Product management functions
  const handleShowProductForm = () => {
    setShowProductForm(true)
    setEditingProductId(null)
    setProductFormName('')
    setProductFormCalories('')
    setProductError(null)
  }

  const handleEditProduct = (product) => {
    setShowProductForm(true)
    setEditingProductId(product.id)
    setProductFormName(product.name)
    setProductFormCalories(product.caloriesPer100g.toString())
    setProductError(null)
  }

  const handleCancelProductForm = () => {
    setShowProductForm(false)
    setEditingProductId(null)
    setProductFormName('')
    setProductFormCalories('')
    setProductError(null)
  }

  const handleSaveProduct = async (e) => {
    e.preventDefault()

    if (!productFormName.trim()) {
      setProductError('Please enter a product name')
      return
    }

    const caloriesNum = parseFloat(productFormCalories)
    if (isNaN(caloriesNum) || caloriesNum <= 0) {
      setProductError('Please enter valid calories per 100g')
      return
    }

    try {
      setProductLoading(true)
      setProductError(null)

      if (editingProductId) {
        // Update existing product
        await updateProduct(editingProductId, productFormName, caloriesNum)
        setProducts(products.map(p =>
          p.id === editingProductId
            ? { ...p, name: productFormName, caloriesPer100g: caloriesNum }
            : p
        ))
      } else {
        // Add new product
        const newProduct = await addProduct(user.uid, productFormName, caloriesNum)
        setProducts([...products, newProduct].sort((a, b) => a.name.localeCompare(b.name)))
      }

      handleCancelProductForm()
    } catch (err) {
      setProductError(err.message)
    } finally {
      setProductLoading(false)
    }
  }

  const handleDeleteProduct = async (productId) => {
    if (!confirm('Are you sure you want to delete this product?')) {
      return
    }

    try {
      await deleteProduct(productId)
      setProducts(products.filter(p => p.id !== productId))
    } catch (err) {
      console.error('Error deleting product:', err)
    }
  }

  // Meal logging functions
  const handleAddMeal = async (e) => {
    e.preventDefault()

    if (!selectedProductId) {
      setMealError('Please select a product')
      return
    }

    const gramsNum = parseFloat(grams)
    if (isNaN(gramsNum) || gramsNum <= 0) {
      setMealError('Please enter a valid amount in grams')
      return
    }

    try {
      setMealLoading(true)
      setMealError(null)

      const product = products.find(p => p.id === selectedProductId)
      const calories = calculateCalories(product.caloriesPer100g, gramsNum)

      const newMeal = await addMeal(
        user.uid,
        selectedProductId,
        product.name,
        gramsNum,
        calories
      )

      setMeals([newMeal, ...meals])
      setSelectedProductId('')
      setGrams('')
      setCalculatedCalories(0)
    } catch (err) {
      setMealError(err.message)
    } finally {
      setMealLoading(false)
    }
  }

  const handleDeleteMeal = async (mealId) => {
    try {
      await deleteMeal(mealId)
      setMeals(meals.filter(meal => meal.id !== mealId))
    } catch (err) {
      console.error('Error deleting meal:', err)
    }
  }

  const remainingCalories = dailyGoal - totalCalories
  const percentageConsumed = (totalCalories / dailyGoal) * 100

  if (authLoading) {
    return (
      <div className="app">
        <h1>MyFitnessComrade</h1>
        <p>Loading...</p>
      </div>
    )
  }

  if (!user) {
    return (
      <div className="app">
        <h1>MyFitnessComrade</h1>
        <p className="subtitle">Your Personal Calorie Tracker</p>

        <div className="card">
          <h2>Login</h2>
          <form onSubmit={handleLogin}>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="Email"
              disabled={loginLoading}
              className="input"
            />
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="Password"
              disabled={loginLoading}
              className="input"
            />

            {loginError && (
              <div className="error">
                <p>{loginError}</p>
              </div>
            )}

            <button type="submit" disabled={loginLoading} className="button">
              {loginLoading ? 'Logging in...' : 'Login'}
            </button>
          </form>
        </div>
      </div>
    )
  }

  return (
    <div className="app">
      <header className="header">
        <h1>MyFitnessComrade</h1>
        <div className="user-info">
          <span>{user.email}</span>
          <button onClick={handleLogout} className="button-small">
            Logout
          </button>
        </div>
      </header>

      {/* Goal Section */}
      <div className="card">
        <h2>Daily Goal</h2>
        {!isEditingGoal ? (
          <div className="goal-display">
            <p className="goal-value">{dailyGoal} calories</p>
            <button onClick={handleEditGoal} className="button-small">
              Edit
            </button>
          </div>
        ) : (
          <div className="goal-edit">
            <input
              type="number"
              value={goalInput}
              onChange={(e) => setGoalInput(e.target.value)}
              className="input"
              placeholder="Enter goal"
            />
            <div className="button-group">
              <button onClick={handleSaveGoal} className="button-small">
                Save
              </button>
              <button onClick={() => setIsEditingGoal(false)} className="button-small">
                Cancel
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Calorie Summary */}
      <div className="card summary-card">
        <h2>Today's Summary</h2>
        <div className="summary-stats">
          <div className="stat">
            <span className="stat-label">Consumed</span>
            <span className="stat-value">{totalCalories}</span>
          </div>
          <div className="stat">
            <span className="stat-label">Goal</span>
            <span className="stat-value">{dailyGoal}</span>
          </div>
          <div className="stat">
            <span className="stat-label">Remaining</span>
            <span className={`stat-value ${remainingCalories < 0 ? 'over-goal' : remainingCalories < dailyGoal * 0.2 ? 'near-goal' : 'under-goal'}`}>
              {remainingCalories}
            </span>
          </div>
        </div>
        <div className="progress-bar">
          <div
            className="progress-fill"
            style={{ width: `${Math.min(percentageConsumed, 100)}%` }}
          ></div>
        </div>
      </div>

      {/* Product Management */}
      <div className="card">
        <div className="card-header">
          <h2>My Products</h2>
          <button onClick={handleShowProductForm} className="button-small">
            Add Product
          </button>
        </div>

        {showProductForm && (
          <form onSubmit={handleSaveProduct} className="product-form">
            <input
              type="text"
              value={productFormName}
              onChange={(e) => setProductFormName(e.target.value)}
              placeholder="Product name (e.g., Chicken Breast)"
              disabled={productLoading}
              className="input"
            />
            <input
              type="number"
              step="0.1"
              value={productFormCalories}
              onChange={(e) => setProductFormCalories(e.target.value)}
              placeholder="Calories per 100g"
              disabled={productLoading}
              className="input"
            />

            {productError && (
              <div className="error">
                <p>{productError}</p>
              </div>
            )}

            <div className="button-group">
              <button type="submit" disabled={productLoading} className="button-small">
                {productLoading ? 'Saving...' : editingProductId ? 'Update' : 'Add'}
              </button>
              <button
                type="button"
                onClick={handleCancelProductForm}
                className="button-small"
                disabled={productLoading}
              >
                Cancel
              </button>
            </div>
          </form>
        )}

        {products.length === 0 ? (
          <div className="empty-state">
            <p>No products yet</p>
            <p className="empty-state-hint">Add your first product to start tracking meals!</p>
          </div>
        ) : (
          <div className="products-list">
            {products.map(product => (
              <div key={product.id} className="product-card">
                <div className="product-info">
                  <span className="product-name">{product.name}</span>
                  <span className="product-calories">{product.caloriesPer100g} cal/100g</span>
                </div>
                <div className="product-actions">
                  <button
                    onClick={() => handleEditProduct(product)}
                    className="button-edit"
                  >
                    Edit
                  </button>
                  <button
                    onClick={() => handleDeleteProduct(product.id)}
                    className="button-delete"
                  >
                    Delete
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Add Meal Form */}
      <div className="card">
        <h2>Log Meal</h2>
        <form onSubmit={handleAddMeal}>
          <select
            value={selectedProductId}
            onChange={(e) => setSelectedProductId(e.target.value)}
            disabled={mealLoading || products.length === 0}
            className="input select"
          >
            <option value="">Select a product...</option>
            {products.map(product => (
              <option key={product.id} value={product.id}>
                {product.name} ({product.caloriesPer100g} cal/100g)
              </option>
            ))}
          </select>

          <input
            type="number"
            step="0.1"
            value={grams}
            onChange={(e) => setGrams(e.target.value)}
            placeholder="Amount in grams"
            disabled={mealLoading || !selectedProductId}
            className="input"
          />

          {calculatedCalories > 0 && (
            <div className="calculated-calories">
              <span className="calories-label">Calories:</span>
              <span className="calories-value">{calculatedCalories} cal</span>
            </div>
          )}

          {mealError && (
            <div className="error">
              <p>{mealError}</p>
            </div>
          )}

          <button
            type="submit"
            disabled={mealLoading || products.length === 0}
            className="button"
          >
            {mealLoading ? 'Adding...' : 'Add Meal'}
          </button>

          {products.length === 0 && (
            <p className="hint">Add products first before logging meals</p>
          )}
        </form>
      </div>

      {/* Meals List */}
      <div className="card">
        <h2>Today's Meals</h2>
        {meals.length === 0 ? (
          <div className="empty-state">
            <p>No meals logged today</p>
            <p className="empty-state-hint">Start by logging your first meal above!</p>
          </div>
        ) : (
          <div className="meals-list">
            {meals.map(meal => (
              <div key={meal.id} className="meal-card">
                <div className="meal-info">
                  <span className="meal-name">
                    {meal.productName || meal.foodName}
                    {meal.grams && <span className="meal-grams"> ({meal.grams}g)</span>}
                  </span>
                  <span className="meal-calories">{meal.calories} cal</span>
                </div>
                <div className="meal-actions">
                  <span className="meal-time">
                    {new Date(meal.mealTime).toLocaleTimeString('en-US', {
                      hour: 'numeric',
                      minute: '2-digit'
                    })}
                  </span>
                  <button
                    onClick={() => handleDeleteMeal(meal.id)}
                    className="button-delete"
                  >
                    Delete
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}

export default App
